---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(ggtree)
library(treeio)
library(tidyverse)
library(tidytree)
library(ape)
library(patchwork)
```

# Phylogenetic tree of organisms that contain AMPs in UniProt 

```{r}
swissprot_amps <- readxl::read_xlsx("data/uniprot-keyword-Antimicrobial+[KW-0929]-reviewed-April2021.xlsx") %>%
  rename(Taxonomic_lineage = `Taxonomic lineage (ALL)`) %>%
  rename(Phylum = `Taxonomic lineage (PHYLUM)`) %>%
  rename(Order = `Taxonomic lineage (ORDER)`) %>%
  rename(Class = `Taxonomic lineage (CLASS)`) %>%
  filter(!grepl("Viruses", Taxonomic_lineage)) %>%
  filter(!grepl("Archaea", Taxonomic_lineage)) %>%
  filter(!grepl("unclassified entries", Taxonomic_lineage)) %>%
  filter(!grepl("A0A6T9YU36", Entry)) %>%
  mutate(label = case_when(str_detect(Taxonomic_lineage, "Bacteria") ~ "Bacteria",
                               str_detect(Phylum, "Nematoda*") ~ "Nematoda",
                                               TRUE ~ Phylum))
```

Count the reviewed AMPs and add the approximate number of identified species per phylum (Bacteria was kept at a kingdom level so tree wouldn't be overcrowded)
```{r}
swissprot_amps_count <- swissprot_amps %>%
  count(label) %>%
  mutate(approx_species_n = c(22000, 1000000, 30000, 30000, 30000, 65000, 11000, 7000, 2400, 85000, 261, 20000, 20000, 500000)) %>%
  rename(AMP_count_rev = n) %>%
  mutate(percentage = round(AMP_count_rev / sum(AMP_count_rev) * 100, digits = 1))

```


The groups in the tax_group column in `swissprot_amps_count` were used to generate a phyilip tree with the [NCBI Taxonomy Browser](https://www.ncbi.nlm.nih.gov/Taxonomy/CommonTree/wwwcmt.cgi) 

Read in tree 
```{r}
tree_text <- readLines("data/tree/phylum_tree.phy") %>%
  paste0(collapse="")

tree <- read.tree(text = tree_text)
```

### Initial tree plot

```{r}
ggtree(tree) %<+% swissprot_amps_count +
  geom_tiplab(offset = 0.3, size=3, color="Black") +
  xlim(NA,20) +
  theme(legend.position = "none") +
  geom_nodelab(aes(label = label), geom = "label") +
  geom_tippoint(aes(size = approx_species_n)) 
```

Match metadata to tree data to make geom_facet work 

```{r}
newtree <- as_tibble(tree) %>% left_join(swissprot_amps_count) %>% as.treedata()
```

### Plot 

So this sort of worksbut there's no axis and when I stuff around with the xlim argument to try and get both plots to appear completely in the plot area , it just seems to mess things up ... !
```{r}
swissprot_amps_count2 <- swissprot_amps_count %>% rename(AMP_count_rev2 = AMP_count_rev)


ggtree(newtree) +
  geom_tiplab(offset = 0.9, size=3, color ="Black") +
  #xlim(-5,40) +
  theme(legend.position = "none") +
      #  plot.margin = margin(1, 0.5, 1, 1, "cm")) + #t, r, b, l
  geom_nodelab(aes(label = label), size = 2.5, vjust = -0.5, hjust = 1.1 ) +
  geom_tippoint(aes(size = approx_species_n), colour = "blue") + 
  geom_facet(data = data.frame(swissprot_amps_count2), panel = "AMP count", geom = ggstance::geom_barh, mapping = aes(x = AMP_count_rev2), stat = "identity", width = .6)
```


## Chordata and Arthropoda 


Chordata represents more than half of the AMPs in SwissProt (52%) so having a closer look at this phylum. the next most abundant group is Arthropoda (~20%) so looking at these also

```{r}
chordata_arthropoda_amps <- swissprot_amps %>% filter(label %in% c("Chordata", "Arthropoda")) %>%
    mutate(Class = case_when(str_detect(Order, "Testudines") ~ "Testudines",
                           str_detect(Class, "Lepidosauria") ~ "Lepidosauria",
                           str_detect(Class, "Chilopoda") ~ "Chilopoda",
                           str_detect(Class, "Merostomata") ~ "Merostomata",
                                                        TRUE ~ Class))

chordata_arthropoda_amps_count <- chordata_arthropoda_amps %>%
  count(Class) %>%
  rename(label = Class) %>% 
  mutate(approx_species_n = c(24000, 8317, 65000, 3000, 10000, 2500, 38, 900000, 9000, 30, 25000, 6495, 4, 300 )) %>%
  rename(AMP_count = n)
```


```{r}
ca_tree_text <- readLines("data/tree/chordata_arthropodatree.phy") %>%
  paste0(collapse="")
ca_tree <- read.tree(text = ca_tree_text)
```


## Plot 

Seems to work but still no x axis and also the scaling is wrong. how to fix it so both plots look good? do I use xlim or something else?
```{r}
newcatree <- as_tibble(ca_tree) %>% left_join(chordata_arthropoda_amps_count) %>% as.treedata()


chordata_arthropoda_amps_count2 <- chordata_arthropoda_amps_count %>% rename(AMP_count2 = AMP_count)


ggtree(newcatree) +
  geom_tiplab(offset = 0.9, size=3, color ="Black") +
  #xlim(-1,10) +
  theme(legend.position = "none") +
      #  plot.margin = margin(1, 0.5, 1, 1, "cm")) + #t, r, b, l
  geom_nodelab(aes(label = label), size = 2.5, vjust = -0.5, hjust = 1.1 ) +
  geom_tippoint(aes(size = approx_species_n), colour = "blue") + 
  geom_facet(data = data.frame(chordata_arthropoda_amps_count2), panel = "AMP count", geom = ggstance::geom_barh, mapping = aes(x = AMP_count2), stat = "identity", width = .6) 
```

Trying to plot both plots together as two separate plots but the bars associated with the AMP count don't align properly to the tree lip labels ..... :(  
```{r}
tree_y <- function(ggtree, data){
  left_join(select(data, label), select(ggtree$data, label, y)) %>%
    pull(y)
}

ca_treeplot <- ggtree(ca_tree) %<+% chordata_arthropoda_amps_count  +
  geom_tiplab(offset = 0.3, size=3, color="Black") +
  xlim(NA,20) +
  theme(legend.position = "none") +
  geom_nodelab(aes(Class = label), geom = "label") +
  geom_tippoint(aes(size = approx_species_n)) 


tstplot <- ggplot(chordata_arthropoda_amps_count, aes(tree_y(ca_treeplot, chordata_arthropoda_amps_count), AMP_count)) +
  geom_col() +
  coord_flip() +
  labs(x = "") +
  theme_classic() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
  

ca_treeplot + tstplot + plot_annotation(tag_levels = "A")
```

