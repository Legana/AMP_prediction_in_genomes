---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(ggtree)
library(treeio)
library(tidyverse)
library(tidytree)
library(ape)
```

# Phylogenetic tree of organisms that contain AMPs in UniProt 

```{r}
uniprot_amps <- readxl::read_xlsx("data/uniprot-keyword Antimicrobial+[KW-0929]April2021.xlsx") %>%
  rename(Taxonomic_lineage = `Taxonomic lineage (ALL)`) %>%
  rename(Phylum = `Taxonomic lineage (PHYLUM)`) %>%
  rename(Order = `Taxonomic lineage (ORDER)`) %>%
  filter(!grepl("Viruses", Taxonomic_lineage)) %>%
  filter(!grepl("Archaea", Taxonomic_lineage)) %>%
  filter(!grepl("unclassified entries", Taxonomic_lineage)) %>%
  filter(!grepl("A0A6T9YU36", Entry)) %>%
  mutate(tax_group = case_when(str_detect(Taxonomic_lineage, "Bacteria") ~ "Bacteria",
                               str_detect(Phylum, "Nematoda*") ~ "Nematoda",
                                               TRUE ~ Phylum))
```

```{r}
unreviewed_amps_count <- uniprot_amps %>% filter(Status == "unreviewed") %>%
  count(tax_group) 
```

Count the reviewed AMPs and add the approximate number of identified species per phylum (Bacteria was kept at a kingdom level so tree wouldn't be overcrowded)
```{r}
swissprot_amps <- uniprot_amps %>% filter(Status == "reviewed")

swissprot_amps_count <- uniprot_amps %>% filter(Status == "reviewed") %>%
  count(tax_group) %>%
  mutate(approx_species_n = c(22000, 1000000, 30000, 30000, 30000, 65000, 11000, 7000, 2400, 85000, 261, 20000, 20000, 500000)) %>%
  rename(AMP_count_rev = n)

```

The groups in the tax_group column in `swissprot_amps_count` were used to generate a phyilip tree with the [NCBI Taxonomy Browser](https://www.ncbi.nlm.nih.gov/Taxonomy/CommonTree/wwwcmt.cgi) 

Read in tree 
```{r}
tree_text <- readLines("data/tree/phylum_tree.phy") %>%
  paste0(collapse="")

tree <- read.tree(text = tree_text)
```


Reorder metadata to match taxonomic group names to tree tip label 

MUST FIX, this only orders 1 vector, not the entire df..

```{r}
swissprot_amps_count$tax_group <- swissprot_amps_count$tax_group[order(match(swissprot_amps_count$tax_group, tree$tip.label))]
```

## Plot 
```{r}
ggtree(tree) %<+% swissprot_amps_count +
  geom_tiplab(offset = 0.3, size=3, color="Black") +
  xlim(NA,20) +
  theme(legend.position = "none") +
  geom_nodelab(aes(label = node), geom = "label") +
  geom_nodepoint() +
  geom_tippoint(aes(size = approx_species_n)) #+
  #geom_facet(data = swissprot_amps_count, panel = "AMP count", geom = geom_point, mapping = aes(size = AMP_count_rev))


```


```{r}
tree_plot <- ggtree(tree) %<+% swissprot_amps_count +
  geom_tiplab(offset = 0.3, size=3, color="Black") +
  xlim(NA,20) +
  theme(legend.position = "none") +
  geom_nodelab(aes(label = node), geom = "label") +
  geom_nodepoint() +
  geom_tippoint(aes(size = approx_species_n))
```

no workies :( 

#object 'AMP_count_rev' not found
```{r, eval = FALSE}
tree_plot +
  ggtree::geom_facet(mapping = aes(size = AMP_count_rev), data = swissprot_amps_count, geom = ggplot2::geom_point, panel = "AMP count")

facet_plot(tree_plot, panel = "AMP count", mapping = aes(x = AMP_count_rev), data = swissprot_amps_count, geom = ggplot2::geom_point)
```



