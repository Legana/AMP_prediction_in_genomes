---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(ggtree)
library(treeio)
library(tidyverse)
library(tidytree)
library(ape)
library(patchwork)
library(ggnewscale)
```

# Phylogenetic tree of organisms that contain AMPs in UniProt 

```{r}
swissprot_amps <- readxl::read_xlsx("data/uniprot-keyword-Antimicrobial+[KW-0929]-reviewed-April2021.xlsx") %>%
  rename(Taxonomic_lineage = `Taxonomic lineage (ALL)`) %>%
  rename(Phylum = `Taxonomic lineage (PHYLUM)`) %>%
  rename(Order = `Taxonomic lineage (ORDER)`) %>%
  rename(Class = `Taxonomic lineage (CLASS)`) %>%
  filter(!grepl("Viruses", Taxonomic_lineage)) %>%
  filter(!grepl("Archaea", Taxonomic_lineage)) %>%
  filter(!grepl("unclassified entries", Taxonomic_lineage)) %>%
  filter(!grepl("A0A6T9YU36", Entry)) %>%
  mutate(label = case_when(str_detect(Taxonomic_lineage, "Bacteria") ~ "Bacteria",
                               str_detect(Phylum, "Nematoda*") ~ "Nematoda",
                                               TRUE ~ Phylum))
```

Count the reviewed AMPs and add the approximate number of identified species per phylum (Bacteria was kept at a kingdom level so tree wouldn't be overcrowded)
```{r}
swissprot_amps_count <- swissprot_amps %>%
  count(label) %>%
  mutate(approx_species_n = c(22000, 1000000, 30000, 30000, 30000, 65000, 11000, 7000, 2400, 85000, 261, 20000, 20000, 500000)) %>%
  mutate(approx_species_n_thousand = approx_species_n / 1000) %>%
  rename(AMP_count = n) %>%
  mutate(percentage = round(AMP_count / sum(AMP_count) * 100, digits = 2))

```


The groups in the tax_group column in `swissprot_amps_count` were used to generate a phyilip tree with the [NCBI Taxonomy Browser](https://www.ncbi.nlm.nih.gov/Taxonomy/CommonTree/wwwcmt.cgi) 

Read in tree 
```{r}
tree_text <- readLines("data/tree/phylum_tree.phy") %>%
  paste0(collapse="")

tree <- read.tree(text = tree_text)
```

Match metadata to tree data to make geom_facet work 

```{r}
newtree <- as_tibble(tree) %>% left_join(swissprot_amps_count) %>% mutate(brcol = case_when(label == "Chordata" ~ "#E7298A", label == "Arthropoda" ~ "#A6761D", TRUE ~ "black")) %>% as.treedata()

```

For some reason geom_facet can't find the metadata so make a copy of the metadata and rename the data we want to plot ...
```{r}
swissprot_amps_count2 <- swissprot_amps_count %>% rename(AMP_count_2 = AMP_count)
```


### Plot 


```{r}
newtree_plot <- ggtree(newtree, aes(colour = I(brcol))) +
  geom_tiplab(offset = 0.9, size= 4, color ="Black") +
  geom_nodelab(aes(label = label), size = 3.5, vjust = -0.5, hjust = 1.1 ) +
  ggnewscale::new_scale_color() +
  geom_tippoint(aes(size = approx_species_n_thousand), colour = "blueviolet") +
  theme_tree2() +
  theme(legend.position = "bottom") +
  labs(size = "Approximate species count (thousands)") +
  xlim_expand(c(0, 20), panel = "Tree")
  
p2 <- facet_plot(newtree_plot, panel = "AMP count", data.frame(swissprot_amps_count2),
           geom = ggstance::geom_barh, mapping = aes(x = AMP_count_2), fill = "forestgreen", stat = "identity", width = .3) 

facet_plot(p2, panel = "AMP count", data = data.frame(swissprot_amps_count2), geom = geom_text, mapping = aes(x = AMP_count_2 + 80, label = AMP_count_2), size = 3)
```


```{r, echo = FALSE}
ggsave("figures/full_tree.png", width = 24, height = 18, units = "cm")
```


## Chordata and Arthropoda 


Chordata represents more than half of the AMPs in SwissProt (52%) so having a closer look at this phylum. the next most abundant group is Arthropoda (~20%) so looking at these also

```{r}
chordata_arthropoda_amps <- swissprot_amps %>% filter(label %in% c("Chordata", "Arthropoda")) %>%
    mutate(Class = case_when(str_detect(Order, "Testudines") ~ "Testudines",
                           str_detect(Class, "Lepidosauria") ~ "Lepidosauria",
                           str_detect(Class, "Chilopoda") ~ "Chilopoda",
                           str_detect(Class, "Merostomata") ~ "Merostomata",
                                                        TRUE ~ Class))

chordata_arthropoda_amps_count <- chordata_arthropoda_amps %>%
  count(Class) %>%
  rename(label = Class) %>% 
  mutate(approx_species_n = c(24000, 8317, 65000, 3000, 10000, 2500, 38, 900000, 9000, 30, 25000, 6495, 4, 300 )) %>%
  mutate(approx_species_n_thousand = approx_species_n / 1000) %>%
  rename(AMP_count = n) %>%
  mutate(percentage = round(AMP_count / sum(AMP_count) * 100, digits = 2)) 
```


```{r}
ca_tree_text <- readLines("data/tree/chordata_arthropodatree.phy") %>%
  paste0(collapse="")
ca_tree <- read.tree(text = ca_tree_text)

newcatree <- ca_tree %>% 
  groupClade("Chordata") %>% 
  groupClade("Arthropoda") %>%
  as_tibble(ca_tree) %>%
  left_join(chordata_arthropoda_amps_count) %>% 
  as.treedata()

chordata_arthropoda_amps_count2 <- chordata_arthropoda_amps_count %>% rename(AMP_count2 = AMP_count)
```


## Plot 

```{r, echo = FALSE}
caplot <- ggtree(newcatree, aes(colour = group)) +
  scale_colour_manual(values = c("#E7298A", "#A6761D"), guide = "none") + 
  geom_tiplab(offset = 0.9, size=4, color ="Black") +
  geom_nodelab(aes(label = label), size = 3.5, vjust = -0.5, hjust = 1.1, colour = "black" ) +
  ggnewscale::new_scale_color() + 
  geom_tippoint(aes(size = approx_species_n_thousand), colour = "blueviolet") +
  theme_tree2() +
  theme(legend.position = "bottom") +
  labs(size = "Approximate species count (thousands)") +
  xlim_expand(c(-4, 20), panel = "Tree") 

ca2 <- facet_plot(caplot, data = data.frame(chordata_arthropoda_amps_count2), panel = "AMP count", geom = ggstance::geom_barh, mapping = aes(x = AMP_count2), fill = "forestgreen", stat = "identity", width = .3)

facet_plot(ca2, panel = "AMP count", data = data.frame(chordata_arthropoda_amps_count2), geom = geom_text, mapping = aes(x = AMP_count2 + 40, label = AMP_count2), size = 3)
```

```{r, echo = FALSE}
ggsave("figures/chordatArthropod_tree.png", width = 24, height = 18, units = "cm")
```

### Combine tree plots


```{r, echo = FALSE, fig.width=10, fig.height=9}
newtree_plot <- ggtree(newtree, aes(color = I(brcol))) + 
  geom_tiplab(offset = 0.9, size= 3.5, color ="Black") +
  geom_nodelab(aes(label = label), size = 3, vjust = -0.5, hjust = 1.1 ) +
  ggnewscale::new_scale_color() + 
  geom_tippoint(aes(size = approx_species_n_thousand), colour = "blueviolet") +
  theme_tree2() +
  theme(legend.position = "bottom") +
  labs(size = "Approximate species count (thousands)") +
  xlim_expand(c(0, 20), panel = "Tree")
  
p2 <- facet_plot(newtree_plot, panel = "AMP count", data.frame(swissprot_amps_count2),
           geom = ggstance::geom_barh, mapping = aes(x = AMP_count_2), fill = "forestgreen", stat = "identity", width = .3) 

p3 <- facet_plot(p2, panel = "AMP count", data = data.frame(swissprot_amps_count2), geom = geom_text, mapping = aes(x = AMP_count_2 + 80, label = AMP_count_2), size = 3)

caplot <- ggtree(newcatree, aes(colour = group)) +
  scale_colour_manual(values = c("#E7298A", "#A6761D"), guide = "none") + 
  geom_tiplab(offset = 0.9, size=3.5, color ="Black") +
  geom_nodelab(aes(label = label), size = 3.5, vjust = -0.5, hjust = 1.1, colour = "black" ) +
  ggnewscale::new_scale_color() + 
  geom_tippoint(aes(size = approx_species_n_thousand), colour = "blueviolet") +
  theme_tree2() +
  theme(legend.position = "none") +
#  labs(size = "Approximate species count (thousands)") +
  xlim_expand(c(-4, 20), panel = "Tree") +
  guides(size = "none")


ca2 <- facet_plot(caplot, data = data.frame(chordata_arthropoda_amps_count2), panel = "AMP count", geom = ggstance::geom_barh, mapping = aes(x = AMP_count2), fill = "forestgreen", stat = "identity", width = .3) 


ca3 <- facet_plot(ca2, panel = "AMP count", data = data.frame(chordata_arthropoda_amps_count2), geom = geom_text, mapping = aes(x = AMP_count2 + 40, label = AMP_count2), size = 3)

p3 / ca3  + plot_annotation(tag_levels = 'A') + plot_layout(guides = "collect") & theme(legend.position = 'bottom') 


```


```{r, echo = FALSE}
ggsave("figures/combined_tree.png", width = 23, height = 18, units = "cm")
```

**Figure #:** The number of AMPs present in the SwissProt database corresponding to A) eukaryotic phyla and bacteria and B) classes within the metazoan phyla Chordata (pink branches) and Arthropoda (brown branches)




